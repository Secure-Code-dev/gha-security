policies:
  plaintext-secrets:
    code: GHA-SEC001
    level: error
    description: "Plaintext secrets should not appear in workflows"
    pattern: (?i)echo\s+[\"']?\${{\s*secrets\.[^}]+}}[\"']?
    url: https://github.com/learningcicd/GHA-All-composite/blob/main/policy-scanner/Policy-user-guide.md#gha-sec001-plaintext-secrets
    exclude:
  
  untrusted-input:
    code: GHA-SEC002
    level: error
    description: "Untrusted user input should not be used directly in shell commands"
    pattern: \${{\s*github\.event\.(inputs|pull_request)\.[^}]+}}
    url: https://github.com/learningcicd/GHA-All-composite/blob/main/policy-scanner/Policy-user-guide.md#gha-sec002-untrusted-input-in-shell-commands
    exclude:

  minimally-scoped-credentials:
    code: GHA-SEC003
    level: warning
    description: "Workflow is missing 'permissions' block"
    missing_block: permissions
    url: https://github.com/learningcicd/GHA-All-composite/blob/main/policy-scanner/Policy-user-guide.md#gha-sec003-minimally-scoped-credentials
    exclude:
      - .github/workflows/new-changes.yaml

  unknown-actions:
    code: GHA-SEC004
    level: warning
    description: "Action used is not from an allowlisted org"
    pattern: uses:\s*([^\s/@]+/[^\s@]+)@[\w.-]+
    url: https://github.com/learningcicd/GHA-All-composite/blob/main/policy-scanner/Policy-user-guide.md#gha-sec004-unknown-actions
    exclude:
    allowlist:
      - actions
      - github
      - rtCamp

  non-specific-version-tags:
    code: GHA-SEC005
    level: warning
    description: "Action is not pinned to a specific commit SHA"
    pattern: uses:\s+[^\s@]+@(main|master|latest|v\d+(?![\.\-]))\b
    url: https://github.com/learningcicd/GHA-All-composite/blob/main/policy-scanner/Policy-user-guide.md#gha-sec005-non-specific-version-tags
    exclude:

  self-hosted-runners:
    code: GHA-SEC006
    level: warning
    description: "Self-hosted runners should not be used"
    pattern: runs-on:\s*\[?.*self-hosted.*
    url: https://github.com/learningcicd/GHA-All-composite/blob/main/policy-scanner/Policy-user-guide.md#gha-sec006-self-hosted-runners
    exclude:

  pull_request_target:
    code: GHA-SEC007
    level: error
    description: "Avoid using pull_request_target with external ref checkout"
    pattern: |
      on:\s*pull_request_target[\s\S]*?- uses: actions/checkout@.*[\s\S]*?ref:\s*\${{\s*github\.event\.pull_request\.head\.sha\s*}}
    url: https://github.com/learningcicd/GHA-All-composite/blob/main/policy-scanner/Policy-user-guide.md#gha-sec007-pull_request_target-and-external-sha
    exclude:

  artifact-secrets-upload:
    code: GHA-SEC008
    level: error
    description: Artifacts potentially exposing secrets (e.g., uploading `.env`, `.pem`, `.key`, `.crt`, `.secret` files).
    pattern: 'path:\s*["'']?.*?\.(env|pem|key|crt|secret)["'']?'
    url: https://github.com/learningcicd/GHA-All-composite/blob/main/policy-scanner/Policy-user-guide.md#gha-sec008-artifact-uploads-with-sensitive-files
    exclude:

  missing-download-checksum:
    code: GHA-SEC009
    level: warning
    description: Downloading files using curl/wget without checksum validation (e.g., sha256sum or GPG).
    pattern: '(wget)\s+.*(?<!sha256sum)(?<!gpg)'
    url: https://github.com/learningcicd/GHA-All-composite/blob/main/policy-scanner/Policy-user-guide.md#gha-sec009-missing-checksum-for-downloads
    exclude:

  secrets-in-env:
    code: GHA-SEC010
    level: error
    description: Direct usage of secrets in `env:` block, which may expose them in logs or misuse them.
    pattern: 'env:\s*\n(\s+[A-Z_]+:\s*\${{\s*secrets\.[^}]+}})+'
    url: https://github.com/learningcicd/GHA-All-composite/blob/main/policy-scanner/Policy-user-guide.md#gha-sec010-secrets-in-global-env
    exclude:

  auto-approve-pull-requests:
    code: GHA-SEC011
    level: error
    description: Auto-approving pull requests via `gh pr review --approve` or similar commands.
    pattern: 'gh\s+pr\s+review\s+.*--approve'
    url: https://github.com/learningcicd/GHA-All-composite/blob/main/policy-scanner/Policy-user-guide.md#gha-sec011-auto-approve-pull-requests
    exclude:

  continue-on-error-used:
    code: GHA-SEC012
    level: warning
    description: "Usage of `continue-on-error: true` may hide errors in CI/CD."
    pattern: 'continue-on-error:\s*true'
    url: https://github.com/learningcicd/GHA-All-composite/blob/main/policy-scanner/Policy-user-guide.md#gha-sec012-continue-on-error-true
    exclude:

  deprecated-set-output:
    code: GHA-SEC013
    level: warning
    description: Use of deprecated `set-output` command (replaced by environment files).
    pattern: 'echo\s+"?::set-output\s+name=.*"'
    url: https://github.com/learningcicd/GHA-All-composite/blob/main/policy-scanner/Policy-user-guide.md#gha-sec013-deprecated-set-output-command
    exclude:

  gcp-legacy-auth:
    code: GHA-SEC014
    level: warning
    description: "Avoid using legacy GCP authentication via credentials_json. Prefer OIDC with Workload Identity Federation."
    pattern: 'uses:\s*["'']?google-github-actions/auth@v2["'']?'
    url: https://github.com/learningcicd/GHA-All-composite/blob/main/policy-scanner/Policy-user-guide.md#gha-sec014-use-of-legacy-gcp-authentication
    exclude:
